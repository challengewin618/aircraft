<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Airport Heat Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.2/css/bootstrap.min.css"
          type="text/css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.css"
          type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
          type="text/css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script type="text/javascript" charset="utf8"
            src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB7zRbK_udn4vYNr4neiaPd71SuyldNIg4&libraries=visualization"></script>
    <style>
        h2 {
            margin-bottom: 20px;
        }

        .root {
            padding: 20px;
            width: 1200px;
            min-width: 1200px;
            margin: 50px auto;
        }

        .status {
            width: 800px;
            margin: 30px auto;
        }

        .status .col {
            padding: 15px;
        }

        .status .col div {
            padding: 10px 50px;
            display: flex;
            justify-content: space-between;
        }

        .status .col:first-child {
            border-right: 1px solid #ced4da;
        }

        .status .col span {
            float: right;
        }

        .icao-list {
            margin-top: 50px;
            width: 100%;
        }

        .icao-list td,
        .icao-list th {
            border-top: 1px solid #ACACAC;
            padding: 10px;
            text-align: center !important;
        }

        .btn-visibility:after {
            content: 'Show ˅';

        }

        .btn-visibility.hidden:after {
            content: 'Hide ˄';
        }

        .graph {
            margin: 30px auto;
        }

        .graph-sm {
            width: 600px;
            height: 300px;
            margin: 30px auto;
        }

        .total-route {
            background: #727272;
            padding: 3px 10px;
            color: white;
        }

        .loading {
            position: fixed;
            background-color: rgba(0, 0, 0, 0.2);
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .loading > button {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .flex-1 {
            flex: 1;
        }

        .btn-gray {
            background: #D9D9D9;
            border-radius: 20px;
        }

        .btn-gray:hover {
            background: #e9e9e9;
        }

        .filter-box {
            width: 600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-gap: 20px;
        }
    </style>
</head>
<body>
<div class="root">
    <h2>Airport Heat Map</h2>

    <div class="d-flex align-items-center" style="width: 700px; margin: 30px auto;">
        <div style="min-width: 120px;"><h4>Filters</h4></div>
<!--        <div class="d-grid flex-1" style="grid-template-columns: repeat(4, 1fr); grid-gap: 10px;">-->
<!--            <a class="btn btn-gray">Airport Name</a>-->
<!--            <a class="btn btn-gray">continent</a>-->
<!--            <a class="btn btn-gray">Country</a>-->
<!--            <a class="btn btn-gray">City</a>-->
<!--            <a class="btn btn-gray">Jet Class</a>-->
<!--            <a class="btn btn-gray">Make</a>-->
<!--            <a class="btn btn-gray">Model</a>-->
<!--            <a class="btn btn-gray">Date</a>-->
<!--        </div>-->
        <div class="filter-box flex-1">
            <div id="filter_airport">
                Airport Name
                <input type="text" class="form-control" id="airport"/>
            </div>

            <div id="filter_continent">
                Continent
                <select class="form-control" id="continent">
                    <option value="">All</option>
                    <option value="Africa">Africa</option>
                    <option value="Asia">Asia</option>
                    <option value="Caribbean">Caribbean</option>
                    <option value="Central America">Central America</option>
                    <option value="Europe">Europe</option>
                    <option value="Middle East">Middle East</option>
                    <option value="North America">North America</option>
                </select>
            </div>
            <div id="filter_country">
                Country
                <select class="form-control" id="country">
                </select>
            </div>
            <div id="filter_city">
                City
                <select class="form-control" id="city">
                </select>
            </div>
            <div id="filter_jet">
                Jet Class
                <select class="form-control" id="jet">
                </select>
            </div>
            <div id="filter_make">
                Make
                <select class="form-control" id="make">
                </select>
            </div>
            <div id="filter_model">
                Model
                <select class="form-control" id="model">
                </select>
            </div>
            <div id="filter_date">
                Date
                <input class="form-control datepicker" id="date"/>
            </div>
            <a class="btn btn-gray" onclick="onSearch()">Search</a>
        </div>
    </div>


    <div class="d-flex status">
        <div class="col">
            <b>Total Movements(Year)</b>
            <span id="movements_year">0</span>
        </div>
        <div class="col">
            <b>Total Movements(Last Month)</b>
            <span id="movements_month">0</span>
        </div>
    </div>

    <div id="map" style="width: 800px; height: 400px; margin: 0 auto;">

    </div>

    <div class="graph">
        <canvas id="graph"></canvas>
    </div>

    <h4>Most Popular Airports</h4>
    <table class="icao-list" id="icao_list">
        <thead>
        <tr>
            <th>Airport Name</th>
            <th>ICAO Code</th>
            <th>City</th>
            <th>Country</th>
            <th>Total Movements</th>
            <th>Most Popular Aircraft</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td colspan="6">Empty Data</td>
        </tr>
        </tbody>
    </table>

    <div class="text-center" style="margin-top: 20px;">
        <label class="total-route">Total Routes: <span id="total_route">0</span></label>
    </div>

</div>

<div class="loading" id="loader" style="display: none">
    <button class="btn btn-primary" type="button" disabled>
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Loading...
    </button>
</div>

<script>
    var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 3,
        center: {
            lat: 51.507351,
            lng: -0.127758
        },//London
        mapTypeId: google.maps.MapTypeId.TERRAIN
    });

    $(document).ready(function () {
        $('#country').load("country_list.html");
        $('#city').load("city_list.html");
        $('#jet').load("jet_list.html");
        $('#make').load("make_list.html");
        $('#model').load("model_list.html");
    });

    $('.datepicker').datepicker({
        startView: 1,
        minViewMode: 1,
        format: 'yyyy-mm'
    });

    $(document).ajaxStart(function () {
        // show loader on start
        $("#loader").show();
    }).ajaxSuccess(function () {
        // hide loader on success
        $("#loader").fadeOut();
    });

    var countryList;
    var aircraftList;
    var aircraftModelList;
    var table;
    var airportList;
    var data = [];
    var finalList = [];

    //filter
    var airport = '';
    var continent = '';
    var country = '';
    var city = '';
    var jet = '';
    var make = '';
    var model = '';
    var date = '';
    var heatMap;

    getCountryList();

    function getCountryList() {
        fetch("./country_code.json")
            .then(response => response.json())
            .then(json => {
                countryList = json;
                getAircraftList();
            });
    }

    function getAircraftList() {
        fetch("./aircraft_type.json")
            .then(response => response.json())
            .then(json => {
                aircraftList = json;
                getAircraftModelList();
            });
    }

    function getAircraftModelList() {
        fetch("./aircraft_model.json")
            .then(response => response.json())
            .then(json => {
                aircraftModelList = json;
                getAirportList();
            });
    }

    function getAirportList() {
        fetch("./icao_coordinates.json")
            .then(response => response.json())
            .then(json => {
                airportList = json;
                testData();
            });
    }

    function testData() {
        $.ajax({
            url: 'server.php?f=read_data',
            type: 'GET',
            timeout: 1000000,
            success: function (result) {
                if (result == 'success') {
                    getData();
                } else {
                    alert('It takes long time to writxe to file\nPlease try after 10 minutes');
                }
            }
        });
    }

    function getData() {
        data = [];
        for (var i = 0; i < aircraftList.length; i++) {
            $.ajax({
                url: aircraftList[i] + '.json',
                type: 'GET',
                async: false,
                dataType: 'json',
                success: function (result) {
                    if (result['aircraft']) {
                        for (let j = 0; j < result['aircraft'].length; j++) {
                            data.push(result['aircraft'][j]);
                        }
                    }
                }
            });
        }
        invalidate();
    }

    function formatNumber(x) {
        return parseInt(x).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function invalidate() {
        $("#loader").show();
        if (table) {
            table.destroy();
        }
        $('#icao_list tbody').empty();
        finalList = [];

        let totalGraphData = {};
        let yearMovements = 0;
        let monthMovements = 0;

        const thisYear = (new Date()).getFullYear();
        const lastMonth = (new Date()).getMonth();

        for (let i = 0; i < data.length; i++) {
            let statistics = data[i]['aircraftStatitics'];

            const typeDescription = data[i]['typeDescription'];
            if (!aircraftModelList[typeDescription]) {
                continue;
            }
            if (jet !== '' && (aircraftModelList[typeDescription]['jet'] !== jet)) {
                continue;
            }

            if (make !== '' && (aircraftModelList[typeDescription]['make'] !== make)) {
                continue;
            }

            if (model !== '' && (aircraftModelList[typeDescription]['model'] !== model)) {
                continue;
            }

            if (statistics) {
                for (let j = 0; j < statistics.length; j++) {
                    let year = statistics[j].year;
                    let month = statistics[j].month;

                    if (date !== '' && (date !== year + '-' + (month > 10 ? month : '0' + month))) {
                        continue;
                    }

                    let movements = 0;
                    if (statistics[j].airportMovements) {
                        for (let k = 0; k < statistics[j].airportMovements.length; k++) {
                            let icaoCode = statistics[j].airportMovements[k].icaoCode;
                            if (airportList[icaoCode] === undefined) {
                                continue;
                            }

                            if (airport !== '' && (!airportList[icaoCode]['airport'].includes(airport))) {
                                continue;
                            }

                            if (continent !== '' && (airportList[icaoCode]['continent'] !== continent)) {
                                continue;
                            }

                            if (country !== '' && (airportList[icaoCode]['country'] !== country)) {
                                continue;
                            }

                            if (city !== '' && (airportList[icaoCode]['city'] !== city)) {
                                continue;
                            }

                            let movement = statistics[j].airportMovements[k].movements;
                            movements += movement;
                            if (airportList[icaoCode]) {
                                if (airportList[icaoCode]['popular_movement'] === undefined) {
                                    airportList[icaoCode]['popular_movement'] = 0;
                                }
                                if (movement > airportList[icaoCode]['popular_movement']) {
                                    airportList[icaoCode]['popular_movement'] = movement;
                                    airportList[icaoCode]['popular_aircraft'] = data[i]['typeDescription'];
                                }
                                airportList[icaoCode]['count'] = (airportList[icaoCode]['count'] ?? 0) + movement;
                                if (!finalList.includes(icaoCode)) {
                                    finalList.push(icaoCode);
                                }
                                // if (airportList[icaoCode]['graphData'] === undefined) {
                                //     airportList[icaoCode]['graphData'] = {};
                                // }
                                // if (airportList[icaoCode]['graphData'][year] === undefined) {
                                //     airportList[icaoCode]['graphData'][year] = {};
                                // }
                                // airportList[icaoCode]['graphData'][year][month] = (airportList[icaoCode]['graphData'][year][month] ?? 0) + movement;
                            }
                        }
                    }
                    if (totalGraphData[year] === undefined) {
                        totalGraphData[year] = {};
                    }
                    totalGraphData[year][month] = (totalGraphData[year][month] ?? 0) + movements;
                    if (year === thisYear) {
                        yearMovements += movements;
                    }
                    if (year === thisYear && month === lastMonth) {
                        monthMovements += movements;
                    }
                }
            }
        }

        $('#icao_list tbody').empty();
        for (let i = 0; i < finalList.length; i++){
            const icaoCode = finalList[i];
            addTr(airportList[icaoCode].airport, airportList[icaoCode].icao, airportList[icaoCode].city, airportList[icaoCode].country, airportList[icaoCode].count, airportList[icaoCode]['popular_aircraft']);
        }

        drawGraph(document.getElementById('graph'), totalGraphData);
        drawDataTable();
        drawHeatMap();
        $('#total_route').text(formatNumber(finalList.length));
        $('#movements_year').text(formatNumber(yearMovements));
        $('#movements_month').text(formatNumber(monthMovements));
        $("#loader").fadeOut();
    }

    function addTr(airport, icao, city, country, totalMovements, popular, graphData) {
        $('#icao_list tbody').append(`
        <tr>
            <td>${airport}</td>
            <td>${icao}</td>
            <td>${city}</td>
            <td>${country}</td>
            <td>${totalMovements ?? 0}</td>
            <td>${popular ?? ''}</td>
<!--            <td><a class="btn btn-secondary btn-visibility" onclick="onToggleBtn(this)"></a></td>-->
<!--            <input type="hidden" value='{graphData}' class="graphData"/>-->
        </tr>`);
    }


    function onToggleBtn(obj) {
        $(obj).toggleClass('hidden');
        var tr = $(obj).parent().parent();
        var row = table.row(tr);

        if (row.child.isShown()) {
            // This row is already open - close it
            row.child.hide();
        } else {
            // Open this row
            row.child(drawSubGraph(JSON.parse(tr.find('.graphData').val()))).show();
        }
    }

    function drawHeatMap() {
        if (heatMap) {
            heatMap.setMap(null);
        }
        let heatmapData = [];
        for (let i = 0; i < finalList.length; i++){
            const icaoCode = finalList[i];
            heatmapData.push({location: new google.maps.LatLng(airportList[icaoCode].lat, airportList[icaoCode].lng), weight: airportList[icaoCode].count});
        }

        heatMap = new google.maps.visualization.HeatmapLayer({
            data: heatmapData,
            radius: 15,
            map: map,
        });
    }

    function drawSubGraph(data) {
        let div = document.createElement("div");
        div.className = "graph-sm";
        let canvas = document.createElement("canvas");
        drawGraph(canvas, data);
        div.append(canvas);
        return div;
    }

    var monthsNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    var chart;

    function drawGraph(canvas, data) {
        if (chart) {
            chart.destroy();
        }
        chart = new Chart(canvas, {
            type: 'line',
            data: {
                datasets: [{
                    data: data[2022],
                    label: "2022 Movements",
                    borderColor: "#0009F8",
                    backgroundColor: "#0009F8",
                    tension: 0.4
                }, {
                    data: data[2021],
                    label: "2021 Movements",
                    borderColor: "#902F29",
                    backgroundColor: "#902F29",
                    tension: 0.4
                }, {
                    data: data[2020],
                    label: "2020 Movements",
                    borderColor: "#89EF32",
                    backgroundColor: "#89EF32",
                    tension: 0.4
                }, {
                    data: data[2019],
                    label: "2019 Movements",
                    borderColor: "#762DD8",
                    backgroundColor: "#762DD8",
                    tension: 0.4
                }]
            },
            options: {
                plugins: {
                    legend: {
                        position: 'right',
                        align: "start"
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Month',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            callback: function (label, index, labels) {
                                return monthsNames[index];
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Movements',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    }
                }
            }
        });
    }

    function drawDataTable() {
        table = $('#icao_list').DataTable({
            dom: 'tpl'
        });
    }

    function onSearch() {
        airport = $('#airport').val();
        continent = $('#continent').val();
        country = $('#country').val();
        city = $('#city').val();
        jet = $('#jet').val();
        make = $('#make').val();
        model = $('#model').val();
        date = $('#date').val();
        invalidate();
    }
</script>

</body>
</html>
